#include <main.h>
#include <Arduino.h>

#include <ESP32-HUB75-MatrixPanel-I2S-DMA.h>
#include <Font4x5Fixed.h>
#include <Font4x7Fixed.h>
#include <Font5x5Fixed.h>
#include <Font5x7Fixed.h>
#include <SPIFFS.h>
#include <Preferences.h>

#include <WiFi.h>
#include <ESPAsyncWebServer.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <AsyncJson.h>

#include <time.h>
#include <Wire.h>
#include <RTClib.h>
#include <ESP32Time.h>




/**************
**	Globals  **
***************/

//TODO remove Tests
uint16_t testimg[PANEL_X][PANEL_Y] = {{10502,10502,10502,10432,6925,6925,6925,6925,6925,6925,6925,6925,6925,24021,24021,24021,10432,10432,10432,6925,6925,24021,24021,24021,24021,24021,24021,24021,6925,24021,24021,24021,24021,24021,24021,6925,6925,10432,10432,10432,6925,6925,24021,24021,24021,24021,6925,6925,10432,10432,24021,24021,6925,6925,10432,10432,24021,6925,6925,10432,10432,10502,10502,10502},{10502,10502,10502,10432,6925,6925,6925,6925,6925,6925,6925,6925,24021,24021,10432,10432,10432,6925,6925,6925,24021,24021,24021,24021,24021,24021,24021,24021,24021,24021,24021,6925,24021,24021,24021,24021,6925,10432,10432,10432,6925,6925,6925,24021,24021,24021,6925,10432,10432,24021,6925,6925,6925,6925,10432,24021,6925,6925,10432,10432,10432,10502,10502,10502},{10502,10502,10432,6925,6925,6925,6925,24021,24021,6925,6925,6925,24021,10432,10432,6925,6925,6925,24021,24021,6925,6925,6925,6925,6925,24021,24021,24021,24021,24021,24021,24021,6925,24021,24021,24021,6925,6925,10432,10432,10432,6925,6925,24021,24021,6925,6925,10432,10432,10432,6925,6925,6925,10432,10432,24021,6925,6925,10432,10432,24021,10432,10502,10502},{10502,10502,10432,6925,6925,6925,6925,6925,24021,24021,24021,24021,24021,10432,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,24021,24021,24021,24021,24021,24021,24021,24021,6925,10432,10432,10432,6925,6925,24021,6925,6925,10432,10432,10432,10432,10432,6925,6925,10432,24021,6925,6925,6925,10432,10432,24021,10432,10502,10502},{10502,10432,6925,6925,6925,6925,6925,6925,24021,10432,10432,24021,10432,10432,6925,6925,10432,10432,10432,10432,10432,10432,10432,10432,6925,6925,6925,6925,6925,6925,6925,24021,24021,24021,6925,24021,24021,6925,6925,10432,10432,6925,6925,24021,6925,6925,10432,10432,10432,10432,10432,10432,10432,10432,6925,6925,6925,10432,10432,10432,24021,6925,10432,10502},{10502,10432,6925,6925,6925,6925,6925,6925,6925,24021,10432,10432,10432,10432,10432,10432,10432,10432,10432,10432,10432,10432,10432,10432,196,196,196,10432,6925,6925,6925,6925,24021,24021,24021,6925,24021,196,196,196,10432,6925,6925,6925,6925,10432,10432,24021,24021,10432,10432,10432,10432,6925,6925,10432,10432,10432,10432,10432,24021,6925,10432,10502},{10502,10432,6925,6925,6925,6925,6925,6925,6925,24021,10432,10432,10432,10432,10432,10432,10432,10432,10432,10432,10432,10432,196,196,36365,57306,57306,196,10432,6925,6925,6925,6925,24021,24021,6925,196,57306,57306,57306,196,196,24021,6925,10432,10432,24021,24021,6925,6925,10432,10432,10432,10432,10432,10432,24021,10432,10432,10432,10432,24021,10432,10502},{10502,10432,6925,6925,6925,6925,6925,6925,6925,6925,24021,10432,10432,10432,10432,10432,10432,10432,10432,10432,10432,196,36365,57306,57306,196,196,196,10432,10432,10432,6925,6925,6925,24021,24021,196,196,196,36365,36365,57306,196,6925,10432,10432,10432,24021,6925,6925,10432,10432,10432,10432,6925,6925,6925,24021,10432,10432,10432,24021,10432,10502},{10432,6925,6925,6925,6925,6925,6925,6925,6925,6925,24021,10432,10432,10432,10432,10432,10432,10432,24021,24021,196,36365,57306,196,196,24021,10432,10432,10432,10432,10432,10432,10432,6925,6925,24021,6925,6925,6925,196,196,36365,57306,196,10432,10432,10432,10432,6925,10432,10432,10432,6925,6925,6925,6925,6925,24021,10432,10432,10432,24021,6925,10432},{10432,6925,6925,6925,6925,6925,6925,6925,6925,6925,24021,10432,10432,10432,10432,24021,24021,24021,24021,196,36365,57306,196,24021,24021,24021,24021,24021,24021,10432,10432,10432,10432,10432,6925,6925,6925,6925,6925,10432,10432,196,36365,57306,196,24021,10432,10432,10432,10432,10432,6925,6925,6925,6925,6925,6925,24021,24021,10432,10432,24021,6925,10432},{10432,6925,6925,6925,6925,6925,6925,6925,6925,6925,24021,10432,10432,24021,24021,24021,24021,24021,24021,13130,57306,196,6925,6925,6925,6925,6925,6925,6925,24021,24021,24021,10432,10432,10432,6925,24021,6925,6925,10432,10432,6925,196,57306,196,6925,6925,10432,10432,10432,6925,24021,24021,24021,24021,6925,6925,6925,24021,10432,10432,24021,6925,10432},{10432,6925,6925,6925,6925,6925,6925,6925,6925,6925,24021,10432,24021,24021,24021,24021,24021,6925,13130,36365,57306,13130,10432,10432,10432,10432,10432,10432,6925,6925,6925,6925,24021,10432,10432,6925,6925,6925,6925,10432,10432,10432,13130,36365,57306,196,6925,10432,10432,6925,6925,6925,6925,6925,24021,24021,24021,24021,24021,10432,10432,10432,24021,10432},{10432,6925,6925,6925,6925,6925,6925,6925,6925,6925,24021,10432,6925,24021,24021,6925,6925,6925,13130,36365,57306,13130,10432,10432,10432,10432,10432,10432,10432,10432,10432,6925,6925,24021,10432,10432,6925,6925,10432,10432,10432,10432,13130,36365,57306,196,10432,10432,6925,10432,10432,10432,10432,10432,6925,6925,6925,24021,24021,6925,10432,10432,24021,10432},{10432,6925,6925,6925,6925,6925,6925,6925,6925,6925,24021,10432,10432,6925,6925,6925,10432,10432,13130,36365,57306,13130,10432,10432,10432,10432,10432,10432,10432,10432,10432,10432,10432,6925,24021,10432,10432,6925,10432,10432,10432,24021,13130,36365,57306,196,10432,10432,10432,6925,6925,24021,24021,10432,10432,10432,6925,6925,6925,10432,10432,10432,24021,64814},{10432,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,24021,10432,6925,10432,10432,10432,10432,10432,13130,57306,196,10432,10432,24021,24021,24021,24021,10432,10432,10432,10432,10432,10432,24021,10432,10432,6925,10432,10432,24021,6925,196,57306,196,10432,6925,6925,6925,6925,6925,6925,6925,24021,24021,10432,10432,10432,10432,10432,10432,24021,24021,64814},{10432,6925,6925,6925,6925,6925,10432,6925,6925,6925,6925,24021,10432,10432,10432,10432,10432,10432,10432,196,36365,57306,196,24021,24021,24021,24021,24021,24021,24021,24021,10432,10432,10432,6925,24021,10432,6925,10432,10432,10432,196,36365,57306,196,6925,6925,6925,6925,6925,6925,6925,6925,24021,24021,6925,10432,10432,10432,10432,24021,6925,64814,60237},{10432,6925,6925,6925,6925,6925,10432,6925,6925,6925,6925,24021,10432,10432,10432,10432,10432,24021,24021,24021,196,36365,57306,196,196,24021,24021,24021,24021,24021,24021,24021,10432,10432,10432,24021,10432,10432,10432,196,196,36365,57306,196,6925,6925,6925,24021,6925,6925,6925,6925,24021,24021,6925,6925,10432,10432,10432,24021,6925,64814,60237,10432},{10432,6925,6925,6925,6925,6925,10432,6925,10432,6925,6925,6925,24021,10432,10432,24021,24021,24021,24021,24021,6925,196,36365,57306,36365,13130,13130,196,196,196,196,196,196,196,196,196,196,13130,13130,36365,36365,57306,196,6925,6925,6925,6925,6925,6925,24021,24021,24021,24021,6925,6925,10432,10432,10432,24021,6925,6925,64814,60237,10432},{10432,6925,6925,6925,6925,6925,6925,10432,10432,6925,6925,6925,24021,10432,6925,6925,24021,24021,6925,24021,24021,24021,196,36365,57306,57306,13130,36365,57306,57306,57306,57306,57306,57306,57306,57306,36365,13130,57306,57306,57306,196,6925,6925,6925,6925,6925,6925,6925,6925,24021,24021,6925,6925,10432,10432,10432,10432,24021,6925,6925,64814,60237,10432},{10432,6925,6925,6925,6925,6925,6925,10432,6925,6925,6925,6925,24021,10432,10432,6925,6925,6925,24021,24021,24021,6925,196,13130,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,196,6925,6925,6925,6925,6925,6925,24021,24021,24021,6925,6925,10432,10432,10432,10432,24021,6925,6925,64814,60237,6925,10432},{10432,6925,6925,6925,6925,6925,10432,10432,6925,6925,6925,6925,24021,10432,10432,10432,6925,24021,24021,24021,6925,6925,10432,196,36365,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,196,6925,10432,10432,24021,24021,6925,24021,24021,6925,6925,6925,10432,10432,10432,10432,24021,6925,6925,64814,60237,6925,6925,10432},{10432,6925,6925,6925,6925,10432,10432,6925,6925,6925,10432,10432,10432,24021,10432,10432,6925,6925,24021,6925,6925,10432,10432,196,36365,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,196,10432,6925,10432,10432,24021,24021,24021,6925,6925,10432,10432,10432,10432,10432,10432,24021,6925,6925,64814,60237,6925,6925,10432},{10502,10432,6925,6925,6925,10432,6925,6925,10432,10432,10432,6925,6925,24021,10432,10432,10432,6925,6925,6925,10432,10432,24021,196,36365,57306,57306,196,196,57306,57306,57306,57306,57306,57306,196,196,57306,57306,57306,196,6925,24021,24021,6925,10432,6925,6925,6925,10432,10432,10432,10432,10432,10432,24021,6925,6925,64814,60237,60237,6925,10432,10502},{10502,10432,6925,6925,6925,10432,6925,6925,10432,6925,6925,6925,6925,6925,24021,10432,10432,10432,6925,10432,10432,24021,24021,196,36365,57306,196,196,196,196,57306,57306,57306,57306,196,196,196,196,57306,57306,196,6925,6925,24021,24021,6925,10432,10432,10432,10432,10432,24021,24021,6925,10432,24021,6925,6925,64814,60237,6925,6925,10432,10502},{10502,10432,6925,6925,6925,10432,10432,10432,6925,6925,6925,6925,6925,6925,24021,10432,24021,10432,10432,10432,6925,6925,6925,196,13130,57306,196,196,196,196,57306,57306,57306,57306,196,196,196,196,57306,57306,196,6925,6925,6925,24021,24021,6925,10432,10432,10432,24021,6925,6925,6925,6925,10432,24021,6925,64814,60237,6925,6925,10432,10502},{10502,10432,6925,6925,10432,10432,6925,6925,6925,6925,6925,6925,6925,24021,10432,10432,6925,24021,24021,10432,10432,6925,6925,196,13130,57306,196,196,196,196,57306,57306,57306,57306,196,196,196,196,57306,57306,196,6925,6925,6925,24021,24021,6925,10432,10432,10432,24021,6925,6925,6925,6925,6925,6925,6925,64814,60237,6925,6925,10432,10502},{10502,10502,10432,6925,10432,6925,6925,6925,6925,6925,6925,6925,6925,24021,10432,6925,6925,6925,6925,24021,10432,10432,6925,6925,196,57306,196,196,196,196,57306,57306,57306,57306,196,196,196,196,57306,196,6925,6925,24021,6925,24021,24021,10432,10432,10432,10432,24021,6925,6925,6925,6925,6925,6925,6925,64814,60237,6925,10432,10502,10502},{10502,10502,10432,10432,10432,6925,6925,6925,6925,6925,6925,6925,24021,6925,6925,6925,6925,6925,6925,6925,24021,10432,6925,6925,196,36365,57306,196,196,57306,57306,57306,57306,57306,57306,196,196,57306,57306,196,6925,6925,6925,24021,24021,6925,10432,10432,10432,24021,6925,6925,6925,6925,6925,6925,6925,6925,64814,60237,6925,10432,10502,10502},{10502,10502,10432,6925,6925,6925,6925,6925,6925,6925,6925,24021,10432,6925,6925,6925,6925,6925,6925,10432,24021,10432,6925,6925,196,13130,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,196,6925,6925,24021,24021,6925,10432,10432,10432,10432,24021,6925,6925,10432,6925,6925,6925,6925,6925,64814,60237,10432,10432,10502,10502},{10502,10502,10432,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,6925,10432,10432,24021,10432,10432,6925,196,196,36365,36365,57306,57306,57306,57306,57306,57306,57306,57306,57306,57306,196,6925,10432,24021,24021,6925,10432,10432,10432,10432,10432,24021,6925,6925,6925,10432,6925,6925,6925,6925,64814,60237,10432,10432,10502,10502},{10502,10502,10502,10432,6925,6925,6925,6925,6925,6925,10432,6925,6925,6925,6925,6925,6925,6925,10432,6925,6925,24021,10432,196,196,196,196,13130,13130,36365,36365,36365,36365,36365,36365,13130,13130,196,6925,6925,10432,6925,10432,10432,10432,10432,10432,10432,24021,6925,6925,6925,6925,6925,10432,10432,6925,6925,64814,60237,10432,10432,10502,10502},{10502,10502,10502,10432,6925,6925,6925,6925,6925,10432,6925,6925,6925,6925,6925,6925,6925,10432,10432,6925,6925,24021,10432,6925,196,196,196,196,196,196,196,196,196,196,196,196,6925,6925,6925,6925,10432,10432,10432,10432,10432,24021,10432,10432,24021,6925,6925,6925,6925,6925,6925,10432,10432,64814,60237,6925,10432,10432,10502,10502},{10502,10502,10502,10502,10432,6925,6925,6925,196,196,6925,6925,6925,6925,6925,6925,6925,10432,6925,6925,6925,24021,10432,10432,6925,196,196,196,196,196,196,196,196,196,196,196,196,6925,6925,6925,10432,10432,10432,24021,24021,6925,6925,10432,24021,6925,6925,6925,6925,6925,60237,60237,60237,64814,6925,10432,10432,10502,10502,10502},{10502,10502,10502,10502,196,196,196,6925,196,57306,196,196,6925,196,196,6925,6925,10432,6925,6925,10432,6925,24021,10432,196,196,196,196,196,8775,196,8775,8775,196,196,196,196,6925,6925,10432,10432,10432,24021,6925,6925,6925,6925,10432,24021,6925,6925,6925,60237,60237,64814,64814,64814,60237,10432,10432,10432,10502,10502,10502},{10502,10502,10502,196,196,57306,57306,196,36365,196,57306,196,196,196,57306,196,10432,10432,10432,10432,6925,6925,24021,10432,10432,196,196,196,13130,8775,8775,8775,8775,196,8775,196,196,196,6925,10432,10432,10432,24021,6925,6925,6925,6925,24021,6925,6925,6925,60237,64814,64814,64814,64814,64814,64814,60237,10432,10502,10502,10502,64814},{10502,196,196,57306,57306,196,57306,57306,196,36365,196,57306,57306,57306,57306,196,10432,6925,6925,6925,6925,6925,6925,24021,10432,6925,196,8775,13130,8775,13130,8775,8775,8775,8775,196,8775,196,10432,10432,10432,24021,6925,6925,6925,6925,6925,10432,6925,6925,10432,60237,64814,64814,60237,60237,64814,64814,60237,64814,64814,64814,64814,60237},{10502,10502,13130,196,196,13130,36365,36365,196,36365,36365,36365,57306,196,57306,196,196,6925,6925,6925,6925,6925,6925,24021,10432,196,13130,8775,13130,8775,13130,13130,8775,13130,13130,196,8775,8775,196,24021,6925,6925,6925,6925,6925,6925,10432,6925,6925,6925,60237,64814,64814,60237,60237,60237,64814,64814,60237,60237,60237,60237,60237,10502},{196,13130,36365,196,57306,57306,36365,196,196,36365,36365,36365,196,57306,196,196,57306,196,6925,6925,6925,6925,6925,6925,24021,196,8775,13130,13130,8775,13130,8775,13130,13130,196,8775,8775,13130,196,24021,6925,6925,6925,6925,10432,6925,10432,6925,6925,6925,60237,64814,64814,60237,60237,64814,64814,60237,10502,10502,10502,10502,10502,10502},{10502,196,196,57306,57306,36365,36365,196,57306,36365,196,196,196,57306,196,57306,57306,196,6925,6925,6925,6925,6925,6925,6925,196,8775,13130,8775,13130,13130,8775,13130,13130,196,8775,8775,13130,196,6925,6925,6925,6925,6925,6925,10432,10432,10432,6925,60237,60237,64814,64814,64814,64814,64814,60237,60237,60237,60237,60237,10502,10502,10502},{196,57306,36365,196,57306,36365,36365,36365,196,36365,196,36365,57306,57306,57306,57306,57306,196,6925,6925,6925,6925,6925,6925,196,13130,8775,13130,8775,13130,13130,8775,13130,13130,196,8775,8775,13130,8775,196,6925,6925,6925,6925,6925,6925,6925,6925,60237,64814,60237,60237,64814,64814,60237,60237,64814,64814,64814,64814,64814,60237,60237,10502},{57306,36365,36365,196,57306,36365,36365,196,57306,36365,36365,36365,36365,36365,57306,57306,57306,57306,196,6925,6925,6925,6925,6925,196,8775,13130,13130,8775,13130,8775,13130,13130,196,8775,13130,8775,13130,13130,196,6925,6925,6925,6925,6925,6925,6925,6925,60237,60237,60237,10432,60237,60237,64814,64814,64814,64814,64814,64814,64814,64814,64814,60237},{57306,36365,36365,36365,196,36365,36365,196,196,36365,36365,36365,36365,36365,36365,57306,57306,57306,196,6925,6925,6925,6925,6925,196,8775,13130,8775,13130,13130,8775,13130,13130,196,8775,13130,13130,8775,13130,196,6925,6925,6925,6925,6925,6925,6925,60237,64814,60237,10432,10502,10502,60237,64814,64814,64814,64814,64814,64814,64814,64814,64814,64814},{196,196,196,196,57306,36365,36365,36365,196,57306,36365,36365,196,196,36365,36365,57306,196,196,6925,6925,6925,6925,6925,196,13130,13130,8775,13130,13130,8775,13130,196,8775,13130,8775,13130,8775,13130,196,6925,6925,6925,6925,6925,6925,6925,60237,64814,60237,60237,60237,60237,64814,64814,64814,60237,60237,64814,64814,64814,64814,64814,64814},{19086,196,196,196,196,196,196,196,196,57306,57306,36365,196,196,196,36365,196,196,10432,6925,6925,6925,6925,196,13130,8775,8775,13130,13130,8775,13130,13130,196,8775,13130,8775,13130,8775,13130,13130,196,6925,6925,6925,6925,10432,60237,64814,60237,60237,64814,64814,60237,64814,64814,60237,60237,60237,60237,64814,64814,64814,64814,64814},{19086,19086,19086,196,196,196,196,196,196,196,196,36365,36365,196,196,36365,196,196,19086,10432,10432,10432,6925,196,8775,13130,13130,8775,8775,13130,13130,196,196,8775,13130,8775,13130,13130,8775,8775,196,196,10432,10432,10432,60237,64814,60237,64814,64814,60237,60237,60237,64814,64814,60237,60237,60237,60237,64814,64814,64814,64814,64814},{19086,16843,16843,16843,196,196,196,196,196,196,196,196,196,36365,36365,36365,196,19086,19086,19086,19086,19086,10432,196,13130,8775,8775,13130,13130,13130,196,196,196,196,13130,13130,8775,13130,13130,13130,196,196,19086,19086,19086,60237,60237,64814,60237,60237,16843,16843,60237,64814,64814,60237,60237,60237,60237,60237,64814,64814,64814,64814},{16843,16843,16843,16843,196,16843,196,196,196,196,196,196,196,196,196,196,19086,19086,19086,19086,19086,19086,19086,196,8775,13130,13130,13130,196,196,196,196,196,196,196,196,13130,8775,8775,13130,196,196,196,19086,19086,19086,60237,60237,60237,16843,16843,16843,16843,60237,64814,64814,60237,60237,60237,60237,64814,64814,64814,64814},{16843,16843,16843,16843,16843,16843,196,16843,196,16843,196,16843,196,16843,16843,16843,19086,19086,19086,19086,19086,19086,19086,196,13130,196,196,196,196,196,196,196,196,196,196,196,196,196,196,8775,196,196,196,196,19086,19086,16843,16843,16843,16843,19086,19086,16843,60237,64814,64814,64814,64814,60237,64814,64814,64814,64814,60237},{16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,19086,19086,19086,19086,19086,19086,19086,19086,196,196,19086,196,196,196,196,196,196,196,196,196,196,196,196,19086,196,196,19086,196,196,196,19086,19086,19086,19086,19086,19086,19086,16843,60237,64814,64814,64814,64814,64814,64814,64814,64814,64814,60237},{19086,19086,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,196,196,196,196,196,16843,16843,196,196,196,196,196,16843,19086,19086,19086,19086,19086,196,196,19086,19086,19086,19086,19086,19086,19086,16843,60237,60237,64814,64814,64814,64814,64814,60237,60237,16843},{19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,16843,16843,16843,196,196,196,16843,16843,16843,16843,16843,16843,196,196,196,16843,16843,16843,16843,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,16843,16843,60237,60237,60237,60237,60237,16843,16843,16843},{19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,16843,16843,16843,16843,196,196,16843,16843,16843,16843,16843,16843,16843,16843,196,196,16843,16843,16843,16843,16843,16843,16843,16843,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,16843,16843,16843,16843,16843,16843,16843,19086},{19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086},{19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,16843,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086},{19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086},{19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086},{19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086,19086},{14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730,14730},{10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502},{10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502},{10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502},{10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502},{10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502},{10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502,10502}};
unsigned long ms_test = 0;

//pixelmaps
uint16_t icon_twitch[32][32] = {{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},{0,0,0,0,0,0,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,0,0},{0,0,0,0,0,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,0,0},{0,0,0,0,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,0,0},{0,0,0,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,0,0,0,25108,25108,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25109,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,25108,25108,0,0},{0,0,25108,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25108,25108,25108,25108,0,0,0},{0,0,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,0,0,0,25108,25108,25108,25108,25108,25109,25108,25108,25108,25108,25108,0,0,0,0},{0,0,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,0,0,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,0,0,0,0,0},{0,0,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,0,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,0,0,0,0,0,0},{0,0,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,25108,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0,0,25108,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0,0,25108,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0,0,25108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}};

//slopes for mapping ranges to pixel width
//? (output_end - output_start) / (input_end - input_start)
const double slope_brightness = .196;
const double slope_diashow = 0;
const double slope_animation = 0;

//structs
enum overlay_type {
	NO_OVERLAY,
	BRIGHTNESS,
	ANIMATION_SPEED,
	DIASHOW_SPEED,
	DISPLAY_MODE
};

enum display_mode {
	TWITCH_SUBS,
	TWITCH_LIVE,
	YOUTUBE_SUBS,
	YOUTUBE_LIVE,
	STATIC,
	DIASHOW,
	CLOCK_DIGITAL,
	CLOCK_ANALOG
};

struct twitch_channel {
	char* display_name;
	char* name;
	bool live;
	unsigned int subs;
	unsigned int viewer;
	unsigned long ms_last_request;
};

//settings
Preferences preferences;
bool booted = false;
unsigned long ms_current;
bool requested_reset = false;

overlay_type volatile overlay = NO_OVERLAY;
uint8_t volatile brightness = 128;
bool volatile brightness_change = false;


//Wifi
bool wifi_connect = WIFI_CONNECT_DEFAULT;
bool wifi_host = WIFI_HOST_DEFAULT;
bool wifi_setup_complete = true;
const char* wifi_ssid = WIFI_SSID_DEFAULT;
const char* wifi_ap_ssid = WIFI_AP_SSID_DEFAULT;
const char* wifi_password = WIFI_PASSWORD_DEFAULT;
const char* wifi_ap_password = WIFI_AP_PASSWORD_DEFAULT;
unsigned long ms_wifi_connected = 0;
unsigned long ms_wifi_start = 0;


//Server
AsyncWebServer server(80);
HTTPClient http;
const char* api_key;
unsigned long ms_api_key_requested = 0;
unsigned long ms_api_key_approved = 0;


//LED Panel
MatrixPanel_I2S_DMA *panel = nullptr;
display_mode current_mode = TWITCH_SUBS;
bool display_change = false;

uint16_t current_image[PANEL_X][PANEL_Y] = {};

twitch_channel * twitch_channels = {};
int twitch_channel_current = 0;

//Interrupt flags
bool volatile rot1_a_flag = false;
bool volatile rot1_b_flag = false;
bool volatile rot2_a_flag = false;
bool volatile rot2_b_flag = false;
bool volatile rot3_a_flag = false;
bool volatile rot3_b_flag = false;


//RTC
RTC_DS3231 rtc_ext;
ESP32Time rtc_int(0);
bool rtc_ext_enabled = false;
const char* ntp_server = "pool.ntp.org";
const char* timezone = "CET-1CEST,M3.5.0,M10.5.0/3";
bool update_time = true;
unsigned long ms_rtc_ext_adjust = 0;


//Timers
hw_timer_t * timer_overlay = NULL;




/***********
**	Misc  **
************/
void rtc_internal_adjust() {
	DateTime time = rtc_ext.now();
	rtc_int.setTime(time.second(), time.minute(), time.hour(), time.day(), time.month(), time.year());
}

void rtc_external_adjust() {
	struct tm timeinfo;
	if(getLocalTime(&timeinfo, 500))
	{
		rtc_ext.adjust(DateTime(timeinfo.tm_year + 1900, timeinfo.tm_mon + 1, timeinfo.tm_mday, timeinfo.tm_hour, timeinfo.tm_min, timeinfo.tm_sec));
	}
	ms_rtc_ext_adjust = 0;
}

void wifi_on_connected() {
	configTzTime(timezone, ntp_server);
	ms_rtc_ext_adjust = millis() + 5000;
}

const char * generate_uid(){
  /* Change to allowable characters */
  const char possible[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  static char uid[33];
  for(int p = 0, i = 0; i < 32; i++){
    int r = random(0, strlen(possible));
    uid[p++] = possible[r];
  }
  uid[32] = '\0';
  return uid;
}

bool verify_api_key(AsyncWebServerRequest * request) {
	return request->hasHeader("apiKey") && request->getHeader("apiKey")->value().equals(api_key);
}

void format_number(unsigned long x, const char** dst) {
	char number[25];
	sprintf(number, "%lu", x);
	int size = strlen(number);
    char formatted[32];
	
	int formatted_i = 0;
	for(int i = 0; i < size; i++){
		if(i != 0 && (size - i) % 3 == 0) {
			formatted[formatted_i] = '.';
			formatted_i++;
		}
		formatted[formatted_i] = number[i];
		formatted_i++;
	}
	formatted[formatted_i] = '\0';
	
	*dst = strdup(formatted);
}




/**************
**	Display  **
**************/

//Display overlay menu for io switches
void display_overlay() {
	
	if(overlay != NO_OVERLAY) {
		//Background
		panel->fillRect(0, 0, 64, 11, 0);
		
		if(overlay == BRIGHTNESS) {
			//Progress Bar
			panel->drawRect(2, 2, 49, 7, 0xFFFF);

			//maps brightness range to progress bar width
			//? floor(output_start + (slope * (input - input_start)) + 0.5)
			panel->fillRect(4, 4, floor((1 + slope_brightness * (brightness - 24)) + .5), 3, 0xFFFF);
		
			//Sun icon
			panel->drawRect(56, 4, 3, 3, 0xFFFF);

			panel->drawPixel(54, 5, 0xFFFF);
			panel->drawPixel(60, 5, 0xFFFF);
			panel->drawPixel(57, 2, 0xFFFF);
			panel->drawPixel(57, 8, 0xFFFF);

			panel->drawPixel(55, 3, 0xFFFF);
			panel->drawPixel(55, 7, 0xFFFF);
			panel->drawPixel(59, 3, 0xFFFF);
			panel->drawPixel(59, 7, 0xFFFF);

			panel->drawPixel(57, 5, 0xFFFF);
		} else if(overlay == ANIMATION_SPEED) {

		} else if(overlay == DIASHOW_SPEED) {

		} else if(overlay == DISPLAY_MODE) {

		}
	}
}

// Display static images on led matrix by pixelarray
void display_full(uint16_t pixels[PANEL_X][PANEL_Y], bool save_image = true) {
	for(int y = 0; y < PANEL_X; y++) {
		for(int x = 0; x < PANEL_Y; x++) {
			if(save_image)
				current_image[y][x] = pixels[y][x];
			panel->drawPixel(x, y, pixels[y][x]);
		}
	}

	display_overlay();

	if(PANEL_DOUBLE_BUFFER)
		panel->flipDMABuffer();
}

//! Not working
//Display only changes of pixels for the next frame
void display_frame(int size, uint16_t *pixels[3]) {

	//TODO display current image

	for(int i = 0; i < size / 3; i++) {
		panel->drawPixel(pixels[i][0], pixels[i][1], pixels[i][2]);
	}

	display_overlay();

	if(PANEL_DOUBLE_BUFFER)
		panel->flipDMABuffer();
}

//Displays twitch channel with respective viewers / subs
void display_twitch_channel(const char * channel, unsigned int subs, unsigned int viewer = 0);
void display_twitch_channel(const char * channel, unsigned int subs, unsigned int viewer) {
	
	//transparent background
	panel->clearScreen();

	//twitch icon
	for(int y = 0; y < 32; y++) {
		for(int x = 0; x < 32; x++) {
			panel->drawPixel(x + 16, y + 2, icon_twitch[y][x]);
		}
	}

	//text
	int16_t x1, y1;
	uint16_t width, height;
	panel->setTextColor(0xCE59);
	panel->setTextWrap(false);
	panel->setTextSize(1);
	panel->setFont(&Font4x7Fixed);
	panel->getTextBounds(channel, 0, 0, &x1, &y1, &width, &height);
	panel->setCursor(PANEL_X > width ? .5 * (PANEL_X - width) : 0, 43);
	panel->write(channel);

	//counter
	const char* counter;
	format_number(viewer == 0 ? subs : viewer, &counter);
	panel->getTextBounds(counter, 0, 0, &x1, &y1, &width, &height);
	panel->setCursor(PANEL_X > width ? .5 * (PANEL_X - width) : 0, 53);
	panel->write(counter);

	if(viewer != 0) {
	} else {
	}

	display_overlay();

	//print on screen
	if(PANEL_DOUBLE_BUFFER)
		panel->flipDMABuffer();
}

void display_current() {
	switch(current_mode) {
		case TWITCH_SUBS:
			display_twitch_channel("@DerEffi", 1432);
			break;
		default:
			display_full(current_image, false);
	}
}



/************
**	SPFFS  **
*************/

void spffs_setup() {
	//TODO waiting for sd card module
}




/***************
**	Settings  **
****************/

void IRAM_ATTR enable_overlay(overlay_type type) {
	overlay = type;
	timerRestart(timer_overlay);
	timerAlarmEnable(timer_overlay);
}

void IRAM_ATTR disable_overlay() {
	overlay = NO_OVERLAY;
	timerAlarmDisable(timer_overlay);
	display_change = true;
}

void IRAM_ATTR set_brightness(uint8_t value, bool show_overlay) {
	brightness = value;
	brightness_change = true;
	if(show_overlay)
		enable_overlay(BRIGHTNESS);
}




/*****************
**	Interrupts  **
******************/

//next button
void IRAM_ATTR trigger_btn1() {
}

//mode button
void IRAM_ATTR trigger_btn2() {
}

//menu button
void IRAM_ATTR trigger_btn3() {

	//approve api key for server
	unsigned long now = millis();
	if(ms_api_key_requested != 0 && ms_api_key_requested + 30000 > now) {
		ms_api_key_approved = now;
		ms_api_key_requested = 0;
	}
}


void IRAM_ATTR trigger_rot1_a() {
	if(rot1_a_flag && digitalRead(GPIO_ROT1_B) == LOW) {
		rot1_a_flag = false;
		rot1_b_flag = false;
		//TODO Function Code turned left
	} else {
		rot1_b_flag = true;
	}
}

void IRAM_ATTR trigger_rot1_b() {
	if(rot1_b_flag && digitalRead(GPIO_ROT1_A) == LOW) {
		rot1_a_flag = false;
		rot1_b_flag = false;
		//TODO Function Code turned right
	} else {
		rot1_a_flag = true;
	}
}

void IRAM_ATTR trigger_rot1_btn() {
}


void IRAM_ATTR trigger_rot2_a() {
	if(rot2_a_flag && digitalRead(GPIO_ROT2_B) == LOW) {
		rot2_a_flag = false;
		rot2_b_flag = false;
		//TODO Function Code turned left
	} else {
		rot2_b_flag = true;
	}
}

void IRAM_ATTR trigger_rot2_b() {
	if(rot2_b_flag && digitalRead(GPIO_ROT2_A) == LOW) {
		rot2_a_flag = false;
		rot2_b_flag = false;
		//TODO Function Code turned right
	} else {
		rot2_a_flag = true;
	}
}

void IRAM_ATTR trigger_rot2_btn() {
}


//brightness rot
void IRAM_ATTR trigger_rot3_a() {
	if(rot3_a_flag && digitalRead(GPIO_ROT3_B) == LOW) {
		rot3_a_flag = false;
		rot3_b_flag = false;

		set_brightness(brightness = (brightness & 0B11100000) == 0 ? 24 : brightness - 8, true);
	} else {
		rot3_b_flag = true;
	}
}

void IRAM_ATTR trigger_rot3_b() {
	if(rot3_b_flag && digitalRead(GPIO_ROT3_A) == LOW) {
		rot3_a_flag = false;
		rot3_b_flag = false;

		set_brightness((brightness & 0B11111000) == 248 ? 248 : brightness + 8, true);
	} else {
		rot3_a_flag = true;
	}
}

void IRAM_ATTR trigger_rot3_btn() {
}




/************
**	Setup  **
*************/

//Initialize GPIO Pins
void gpio_setup() {

	//Turning off onboard led
	pinMode(48, PULLDOWN);

	//Setting PinModes
	pinMode(GPIO_BTN1, PULLUP);
	pinMode(GPIO_BTN2, PULLUP);
	pinMode(GPIO_BTN3, PULLUP);
	pinMode(GPIO_ROT1_A, PULLUP);
	pinMode(GPIO_ROT1_B, PULLUP);
	pinMode(GPIO_ROT1_BTN, PULLUP);
	pinMode(GPIO_ROT2_A, PULLUP);
	pinMode(GPIO_ROT2_B, PULLUP);
	pinMode(GPIO_ROT2_BTN, PULLUP);
	pinMode(GPIO_ROT3_A, PULLUP);
	pinMode(GPIO_ROT3_B, PULLUP);
	pinMode(GPIO_ROT3_BTN, PULLUP);

	//Setting interrupts
	attachInterrupt(GPIO_BTN1, trigger_btn1, FALLING);
	attachInterrupt(GPIO_BTN2, trigger_btn2, FALLING);
	attachInterrupt(GPIO_BTN3, trigger_btn3, FALLING);
	attachInterrupt(GPIO_ROT1_A, trigger_rot1_a, FALLING);
	attachInterrupt(GPIO_ROT1_B, trigger_rot1_b, FALLING);
	attachInterrupt(GPIO_ROT1_BTN, trigger_rot1_btn, FALLING);
	attachInterrupt(GPIO_ROT2_A, trigger_rot2_a, FALLING);
	attachInterrupt(GPIO_ROT2_B, trigger_rot2_b, FALLING);
	attachInterrupt(GPIO_ROT2_BTN, trigger_rot2_btn, FALLING);
	attachInterrupt(GPIO_ROT3_A, trigger_rot3_a, FALLING);
	attachInterrupt(GPIO_ROT3_B, trigger_rot3_b, FALLING);
	attachInterrupt(GPIO_ROT3_BTN, trigger_rot3_btn, FALLING);

	Wire.setPins(GPIO_RTC_SDA, GPIO_RTC_SCL);
  	Wire.begin();

}

// Initialize LED Matrix
void panel_setup() {

	HUB75_I2S_CFG mxconfig(
		PANEL_X,
		PANEL_Y,
		PANEL_CHAIN,
		{
			GPIO_LEDPANEL_R1,
			GPIO_LEDPANEL_G1,
			GPIO_LEDPANEL_B1,
			GPIO_LEDPANEL_R2,
			GPIO_LEDPANEL_G2,
			GPIO_LEDPANEL_B2,
			GPIO_LEDPANEL_A,
			GPIO_LEDPANEL_B,
			GPIO_LEDPANEL_C,
			GPIO_LEDPANEL_D,
			GPIO_LEDPANEL_E,
			GPIO_LEDPANEL_LAT,
			GPIO_LEDPANEL_OE,
			GPIO_LEDPANEL_CLK
		},
		PANEL_DRIVER,
		PANEL_DOUBLE_BUFFER,
		PANEL_I2C_SPEED,
		PANEL_LATCH_BLINK,
		PANEL_CLOCK_PHASE
	);

	// Display Setup
	panel = new MatrixPanel_I2S_DMA(mxconfig);
	panel->begin();
	panel->clearScreen();
	panel->setPanelBrightness(brightness);

	if(PANEL_DOUBLE_BUFFER)
		panel->flipDMABuffer();

}

//Server setup
void server_setup() {
	if(WiFi.getMode() != WIFI_MODE_NULL) {
		server.begin();

		server.on("/", HTTP_GET, [](AsyncWebServerRequest *request) {
			//TODO Point to sd card if arrived
			request->send(200, "text/plain", "Hello");
		});

		server.on("/status", HTTP_GET, [](AsyncWebServerRequest * request) {
			if(verify_api_key(request)) {
				AsyncJsonResponse *response = new AsyncJsonResponse();
				response->setContentType("application/json");
				response->setCode(200);
				JsonVariant& root = response->getRoot();

				root["onTime"] = ms_current;
				root["wifiAP"] = wifi_connect;
				root["wifiSTA"] = wifi_host;
				root["wifiSetupComplete"] = wifi_setup_complete;
				root["wifiIP"] = WiFi.localIP();
				root["wifiAPIP"] = WiFi.softAPIP();
				root["wifiHostname"] = WiFi.getHostname();
				root["time"] = rtc_int.getLocalEpoch();
				root["timeExtConnected"] = rtc_ext_enabled;
				root["displayMode"] = current_mode;

				response->setLength();
				request->send(response);
			} else {
				request->send(403, "application/json", "{}");
			}
		});

		server.on("/settings", HTTP_GET, [](AsyncWebServerRequest * request) {
			if(verify_api_key(request)) {
				AsyncJsonResponse *response = new AsyncJsonResponse();
				response->setContentType("application/json");
				response->setCode(200);
				JsonVariant& root = response->getRoot();

				root["brightness"] = brightness;
				root["wifiConnect"] = wifi_connect;
				root["wifiHost"] = wifi_host;
				root["wifiSSID"] = wifi_ssid;
				root["wifiAPSSID"] = wifi_ap_ssid;
				root["wifiAPPassword"] = wifi_ap_password;
				root["updateTime"] = update_time;
				root["ntpServer"] = ntp_server;
				root["timezone"] = timezone;
				
				response->setLength();
				request->send(response);
			} else {
				request->send(403, "application/json", "{}");
			}
		});

		server.on("/settings", HTTP_POST, [](AsyncWebServerRequest * request) {
			if(verify_api_key(request)) {
				//TODO set settings
				request->send(200, "application/json", "{}");
			} else {
				request->send(403, "application/json", "{}");
			}
		});

		server.on("/apiKey", HTTP_DELETE, [](AsyncWebServerRequest * request) {
			if(verify_api_key(request)) {
				preferences.begin(PREFERENCES_NAMESPACE, false);
				api_key = generate_uid();
				preferences.putString("api_key", api_key);
				preferences.end();
				request->send(200);
			} else {
				request->send(403, "application/json", "{}");
			}
		});

		server.on("/apiKey", HTTP_GET, [](AsyncWebServerRequest * request) {
			AsyncJsonResponse *response = new AsyncJsonResponse();
			response->setContentType("application/json");
			JsonVariant& root = response->getRoot();

			if(ms_api_key_approved != 0 && ms_api_key_approved + 15000 > millis()) {
				response->setCode(200);
				root["apiKey"] = api_key;
				ms_api_key_approved = 0;
				ms_api_key_requested = 0;
			} else {
				ms_api_key_requested = millis();
				request->send(204, "application/json", "{}");
			}
			
			response->setLength();
			request->send(response);
		});

		server.on("/reset", HTTP_GET, [](AsyncWebServerRequest * request) {
			if(verify_api_key(request)) {
				preferences.begin(PREFERENCES_NAMESPACE, false);
				preferences.clear();
				preferences.end();
				request->send(200);
				requested_reset = true;
			} else {
				request->send(403, "application/json", "{}");
			}
		});
	}
}

// Initialize Wifi if enabled
void wifi_setup() {

	WiFi.setHostname(WIFI_HOSTNAME);
	WiFi.setAutoReconnect(true);

	if(wifi_connect) {
		WiFi.begin(wifi_ssid, wifi_password);
		WiFi.waitForConnectResult(250);
		wifi_setup_complete = false;
		ms_wifi_start = millis();
	} else if(wifi_host) {
		WiFi.softAP(wifi_ap_ssid, wifi_ap_password);
	}
}

//Load preferences from flash
void preferences_load() {

	preferences.begin(PREFERENCES_NAMESPACE, false);
	
	//settings
	if(preferences.isKey("brightness"))
		brightness = preferences.getShort("brightness", brightness);
	if(preferences.isKey("current_mode"))
		current_mode = (display_mode)preferences.getShort("current_mode", current_mode);
	
	//wifi
	if(preferences.isKey("wifi_connect"))
		wifi_connect = preferences.getBool("wifi_connect", WIFI_CONNECT_DEFAULT);

	if(preferences.isKey("wifi_host"))
		wifi_host = preferences.getBool("wifi_host", WIFI_HOST_DEFAULT);
	
	if(preferences.isKey("wifi_ssid"))
		wifi_ssid = strdup(preferences.getString("wifi_ssid", WIFI_SSID_DEFAULT).c_str());
	
	if(preferences.isKey("wifi_ap_ssid"))
		wifi_ap_ssid = strdup(preferences.getString("wifi_ap_ssid", WIFI_AP_SSID_DEFAULT).c_str());
	
	if(preferences.isKey("wifi_password"))
		wifi_password = strdup(preferences.getString("wifi_password", WIFI_PASSWORD_DEFAULT).c_str());
	
	if(preferences.isKey("wifi_ap_password"))
		wifi_ap_password = strdup(preferences.getString("wifi_ap_password", WIFI_AP_PASSWORD_DEFAULT).c_str());

	//ntp
	if(preferences.isKey("ntpServer"))
		ntp_server = strdup(preferences.getString("ntpServer", ntp_server).c_str());

	if(preferences.isKey("timezone"))
		timezone = strdup(preferences.getString("timezone", timezone).c_str());

	if(preferences.isKey("update_time"))
		update_time = preferences.getBool("update_time", update_time);

	//Server
	if(preferences.isKey("api_key")) {
		api_key = strdup(preferences.getString("api_key", api_key).c_str());
	} else {
		api_key = generate_uid();
		preferences.putString("api_key", api_key);
	}

	preferences.end();
}

//Init timers
void timer_setup() {

	setenv("TZ", timezone, 1);
	tzset();
	if(rtc_ext.begin()) {
		rtc_ext.disable32K();
		rtc_ext.disableAlarm(1);
		rtc_ext.disableAlarm(2);
		rtc_ext.clearAlarm(1);
		rtc_ext.clearAlarm(2);
		rtc_ext_enabled = true;
		rtc_internal_adjust();
	}

	//Overlay Timer
	timer_overlay = timerBegin(3, 80, true);
	timerAttachInterrupt(timer_overlay, disable_overlay, true);
	timerAlarmWrite(timer_overlay, 3000000, false);

}

void setup() {
	Serial.begin(9600); //TODO remove after testing
	//while(!Serial); //TODO remove after testing

	preferences_load();
	gpio_setup();
	timer_setup();
	wifi_setup();
	server_setup();
	spffs_setup();
	panel_setup();

	display_current();
	
	booted = true; //TODO move after boot sequence if implemented
}




/***********
**	Loop  **
************/

void loop() {

	ms_current = millis();

	if(booted) {

		//Change panel parameters
		if(brightness_change) {
			brightness_change = false;

			panel->setPanelBrightness(brightness);
			
			display_current();

			preferences.begin(PREFERENCES_NAMESPACE);
			preferences.putShort("brightness", brightness);
			preferences.end();
		}

		if(display_change) {
			display_change = false;
			display_current();
		}

	}

	//Wifi routine
	if(!wifi_setup_complete && ms_current - ms_wifi_connected >= 5000) {
		ms_wifi_connected = ms_current;
		if(WiFi.waitForConnectResult(100) == WL_CONNECTED) {
			wifi_setup_complete = true;
			wifi_on_connected();
		} else if(ms_current - ms_wifi_start >= 60000) {
			ms_wifi_start = ms_current;
			wifi_setup();
		}
	}

	//RTC adjustment after message received
	if(ms_rtc_ext_adjust > 0 && ms_rtc_ext_adjust <= ms_current) {
		rtc_external_adjust();
	}

	//Execute reset from api request
	if(requested_reset) {
		ESP.restart();
	}

	//TODO remove tests
	if(ms_current - ms_test >= 5000) {
		ms_test = ms_current;
		
		// Serial.println(WiFi.localIP().toString());
		// Serial.println(rtc_int.getDateTime());
		// Serial.println(rtc_ext.now().timestamp());
		// Serial.println(api_key);
		// Serial.println(ESP.getFreeHeap());
	}
	
	delay(10);
}